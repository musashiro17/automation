<!DOCTYPE html>
<html>
<body>
<h2>Stage 1 User Submission</h2>
<form id="stage1Form">
  <label for="proposedAlias">Proposed Alias:</label><br>
  <input type="text" id="proposedAlias" name="proposedAlias" required><br><br>

  <label for="managerEmail">Manager Email:</label><br>
  <input type="email" id="managerEmail" name="managerEmail" required><br><br>

  <label for="department">Department:</label><br>
  <input type="text" id="department" name="department" required><br><br>

  <label for="location">Location:</label><br>
  <input type="text" id="location" name="location" required><br><br>

  <input type="submit" value="Submit">
</form>

<script>
document.getElementById("stage1Form").addEventListener("submit", async function(e) {
  e.preventDefault();

  // Generate random CSRF token
  function generateCSRF(length = 20) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let token = '';
    for (let i = 0; i < length; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
    return token;
  }

  const payload = {
    csrf: generateCSRF(),
    hp: "",
    proposedAlias: document.getElementById("proposedAlias").value,
    managerEmail: document.getElementById("managerEmail").value,
    department: document.getElementById("department").value,
    location: document.getElementById("location").value
  };

  console.log("Stage 1 Payload:", payload);
  alert("Submitting Stage 1â€¦ please wait.");

  try {
    // Send payload to Stage 1 webhook
    const res = await fetch("https://musashiro17.app.n8n.cloud/webhook/provision/stage1", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Stage 1 webhook returned error " + res.status);
    const data = await res.json();
    console.log("Stage 1 Completed:", data);

    // If n8n returned an array (like [ { json... } ]), flatten it
    const result = Array.isArray(data) ? (data[0].json || data[0]) : data;

    // Redirect to Stage 2 with encoded data
    const encoded = encodeURIComponent(JSON.stringify(result));
    window.location.href = `stage2.html?data=${encoded}`;

  } catch (err) {
    console.error(err);
    alert("Error submitting Stage 1: " + err.message);
  }
});
</script>
</body>
</html>
