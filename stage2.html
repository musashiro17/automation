<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stage 2 - User Details</title>
<style>
body {
  font-family: Arial, sans-serif;
  max-width: 700px;
  margin: 50px auto;
  padding: 20px;
  background-color: #f5f5f5;
}
.container {
  background-color: white;
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
h2 {
  color: #333;
  margin-bottom: 20px;
}
label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #555;
}
input[type="text"], input[type="email"] {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-sizing: border-box;
  font-size: 14px;
}
input[type="submit"] {
  background-color: #2196F3;
  color: white;
  padding: 12px 30px;
  border: none;
  cursor: pointer;
  font-size: 16px;
  border-radius: 4px;
  width: 100%;
}
input[type="submit"]:hover {
  background-color: #0b7dda;
}
.help-text {
  font-size: 12px;
  color: #666;
  margin-top: -10px;
  margin-bottom: 15px;
}
.error {
  color: #d32f2f;
  font-size: 14px;
  margin-top: -10px;
  margin-bottom: 15px;
  display: none;
}
</style>
</head>
<body>
<div class="container">
  <h2>Stage 2 - User Details</h2>
  <p>Complete the remaining information for user provisioning.</p>

  <form id="stage2Form">
    <label for="givenName">Given Name: *</label>
    <input type="text" id="givenName" name="givenName" required placeholder="First Name">
    
    <label for="surname">Surname: *</label>
    <input type="text" id="surname" name="surname" required placeholder="Last Name">
    
    <label for="displayName">Display Name: *</label>
    <input type="text" id="displayName" name="displayName" required placeholder="e.g., John Doe">
    
    <label for="upn">UPN (Email): *</label>
    <input type="email" id="upn" name="upn" required placeholder="e.g., john.doe@domain.com">
    
    <label for="samAccountName">SAM Account Name: *</label>
    <input type="text" id="samAccountName" name="samAccountName" required placeholder="e.g., jdoe">
    
    <label for="ouDn">OU DN: *</label>
    <input type="text" id="ouDn" name="ouDn" required placeholder="Organizational Unit DN">
    
    <label for="department">Department:</label>
    <input type="text" id="department" name="department" maxlength="64">
    
    <label for="managerEmail">Manager Email:</label>
    <input type="email" id="managerEmail" name="managerEmail" maxlength="128">
    
    <label for="location">Location:</label>
    <input type="text" id="location" name="location" maxlength="64">
    
    <!-- Honeypot field -->
    <input type="text" id="hp" name="hp" style="display:none;" tabindex="-1" autocomplete="off">
    
    <input type="submit" value="Submit Stage 2">
  </form>
</div>

<script>
// Parse Stage 1 data from URL
function getStage1Data() {
  const params = new URLSearchParams(window.location.search);
  if (!params.has("data")) return {};
  try {
    return JSON.parse(decodeURIComponent(params.get("data")));
  } catch {
    return {};
  }
}

// Generate CSRF token
function generateCSRF(length = 32) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let token = '';
  for (let i = 0; i < length; i++) {
    token += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return token;
}

// Prefill fields from Stage 1
const stage1Data = getStage1Data();
document.getElementById("department").value = stage1Data.department || '';
document.getElementById("managerEmail").value = stage1Data.managerEmail || '';
document.getElementById("location").value = stage1Data.location || '';
const csrfToken = generateCSRF();

// Handle Stage 2 form submission
document.getElementById("stage2Form").addEventListener("submit", async function(e){
  e.preventDefault();
  
  const payload = {
    givenName: document.getElementById("givenName").value,
    surname: document.getElementById("surname").value,
    displayName: document.getElementById("displayName").value,
    upn: document.getElementById("upn").value.toLowerCase(),
    samAccountName: document.getElementById("samAccountName").value.toLowerCase(),
    ouDn: document.getElementById("ouDn").value,
    department: document.getElementById("department").value,
    managerEmail: document.getElementById("managerEmail").value,
    location: document.getElementById("location").value,
    groups: [], // can be filled later
    licenses: [],
    permissions: {},
    ddgNotLike: {},
    approvalRequired: false,
    csrf: csrfToken,
    hp: document.getElementById("hp").value
  };

  // Honeypot check
  if(payload.hp !== "") {
    console.error("Honeypot triggered - possible bot submission");
    alert("Invalid submission detected.");
    return;
  }

  const submitBtn = e.target.querySelector('input[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.value = "Submitting...";
  
  try {
    const res = await fetch("https://musashiro17.app.n8n.cloud/webhook/provision/stage2", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    
    if(!res.ok){
      const errorText = await res.text();
      throw new Error(`Stage 2 webhook error ${res.status}: ${errorText}`);
    }

    const data = await res.json();
    console.log("✓ Stage 2 Completed:", data);
    alert("Stage 2 submission successful!");
    
  } catch(err){
    console.error("❌ Error submitting Stage 2:", err);
    alert("Error submitting Stage 2:\n\n" + err.message);
    submitBtn.disabled = false;
    submitBtn.value = "Submit Stage 2";
  }
});
</script>
</body>
</html>
